@page "/saving"
@page "/saving/{stepPath}"
@inject HttpClient Http

<PageTitle>
saving/@stepPath
</PageTitle>

<style>
    .btn {
        color: white;
        padding: 10px 25px;
        text-decoration: none;
        display:inline-block;
        text-align:center;
        width:175px;
        border-radius: 10px;
    }
    .dollar,.percent {
        width: 100px;
    }
</style>

    @if (priorities == null || taxFilings == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        @if (stepPath == null) {
            var prevPriority = priorities[9];
            var nextPriority = priorities[0];
            string prevPage = "/saving/" + prevPriority?.step;
            string nextPage = "/saving/" + nextPriority?.step;
            
            <h2 style="max-width:350px">
                <a style='font-size:24pt' href="@prevPage"><span class="oi oi-arrow-left m-2 aria-hidden="true"></span></a>
                Saving Summary
                <a style='font-size:24pt;float:right' href="@nextPage"><span class="oi oi-arrow-right m-2 aria-hidden="true"></span></a>
            </h2>

            <p>To save money efficiently, you should prioritize the most efficient techniques. This tool helps you apply the <a href="https://www.bogleheads.org/wiki/Prioritizing_investments">Bogleheads Prioritizing Investments wiki</a><span class="oi oi-external-link m-2 aria-hidden="true"></span>. Review and complete pages 1-10.</p>

            <div>
                <EditForm Model="taxFilings.Active">
                    <label>Target Year:</label> <select @bind=taxFilings.CurrentYear><option value=0>2022</option><option value=1>2023</option></select><br/>
                    <label>Estimated Adjusted Gross Income:</label> $<input type=text class=dollar @bind-Value=taxFilings.Active.AdjustedGrossIncome @bind-Value:event=oninput /><br/><br/>
                </EditForm>
                <table>
                    <thead>
                        <th></th>
                        @if(taxFilings.Active.PersonCount > 0) {<th style="padding-right:10px">$</th> }
                        @if(taxFilings.Active.PersonCount > 0) {<th style="padding-right:10px">Match</th> }
                    </thead>

                    @foreach (var priority in priorities) {
                        var href = "/saving/" + @priority.step;
                        <tr>

                            <td>
                                <div>
                                    <a href="@href" style="background:blue" class="m-1 btn" >@priority.number: @priority.bestDiagramTitle</a>
                                </div>
                            </td>
                            @switch (priority.number) {
                                case 1: 
                                   <td style=text-align:right>@taxFilings.Active.EmergencyFund.AmountToSave</td><td></td>
                                   break;
                                case 2:
                                   <td style=text-align:right>
                                        @taxFilings.Active.People[0].EmployerPlan.AmountToSaveForMatch<br/>
                                        @taxFilings.Active.People[1].EmployerPlan.AmountToSaveForMatch
                                   </td>
                                   <td style=text-align:right>
                                        @taxFilings.Active.People[0].EmployerPlan.MatchAmount<br/>
                                        @taxFilings.Active.People[1].EmployerPlan.MatchAmount
                                   </td>
                                   break;
                                case 3:
                                    <td style=text-align:right>
                                        @taxFilings.Active.HighDebts
                                    </td>
                                    break;
                                case 4: 
                                    <td style=text-align:right>
                                        @taxFilings.Active.People[0].HealthSavingsAccount.AmountToSave<br/>
                                        @taxFilings.Active.People[1].HealthSavingsAccount.AmountToSave
                                    </td>
                                    <td style=text-align:right>
                                        @taxFilings.Active.People[0].HealthSavingsAccount.EmployerContribution<br/>
                                        @taxFilings.Active.People[1].HealthSavingsAccount.EmployerContribution
                                    </td>
                                   break;
                                case 5:
                                    @if (taxFilings.Active.AdjustedGrossIncome != null) {
                                        <td style=text-align:right>
                                        @if(taxFilings.Active.PersonCount > 0) {
                                            @switch (taxFilings.Active.People[0].IRAChoice) {
                                                case "traditional":
                                                    <span>IRA: @taxFilings.Active.People[0].IRA.AmountToSave</span><br/>
                                                    break;
                                                case "roth":
                                                    <span>Roth: @taxFilings.Active.People[0].RothIRA.AmountToSave</span><br/>
                                                    break;
                                                default:
                                                    break;
                                            }
                                        }
                                        @if(taxFilings.Active.PersonCount > 1) {
                                            @switch (taxFilings.Active.People[1].IRAChoice) {
                                                case "traditional":
                                                    <span>IRA: @taxFilings.Active.People[1].IRA.AmountToSave</span><br/>
                                                    break;
                                                case "roth":
                                                    <span>Roth: @taxFilings.Active.People[1].RothIRA.AmountToSave</span><br/>
                                                    break;
                                                default:
                                                    break;
                                            }
                                        }
                                        </td>
                                    }
                                   break;
                                case 6: 
                                    <td style=text-align:right>
                                        @taxFilings.Active.People[0].EmployerPlan.AmountToSaveForNonMatched<br/>
                                        @taxFilings.Active.People[1].EmployerPlan.AmountToSaveForNonMatched
                                    </td>
                                    break;
                                case 7: 
                                   <td style=text-align:right>@taxFilings.Active.People[0].EmployerPlan.AmountToSaveForBackdoorRoth</td>
                                   <td style=text-align:right>@taxFilings.Active.People[1].EmployerPlan.AmountToSaveForBackdoorRoth</td>
                                   break;
                                case 8:
                                    <td style=text-align:right>
                                        @taxFilings.Active.MediumDebts
                                    </td>
                                    break;
                                case 9: 
                                    <td style=text-align:right>
                                        @if(taxFilings.Active.PersonCount > 0) {<span>no limits</span> }
                                        @if(taxFilings.Active.PersonCount > 1) {<br/><span>no limits</span> }
                                    </td>
                                    break;                                                                   
                                case 10:
                                    <td style=text-align:right>
                                        @taxFilings.Active.LowDebts
                                    </td>
                                    break;
                                default:
                                    <td style=text-align:right>NYI</td><td></td>
                                    break;
                            }
                        </tr>
                    }
                </table>
            </div>
            
            <a style='font-size:24pt' href="@prevPage"><span class="oi oi-arrow-left m-2 aria-hidden="true"></span></a>
            <a style='font-size:24pt;float:right' href="@nextPage"><span class="oi oi-arrow-right m-2 aria-hidden="true"></span></a><br/>
        }
        else if (stepPath == "tax-filing-info") {

        }
        else
        {
            @foreach (var priority in priorities) {
                @if (priority.step == stepPath) {
                    var prevPriority = priority.number >= 1 + 1 ? priorities[priority.number - 2] : null;
                    var nextPriority = priority.number <= 10 - 1 ? priorities[priority.number] : null;
                    string prevPage = "/saving/" + prevPriority?.step;
                    string nextPage = "/saving/" + nextPriority?.step;

                    <h2 style="max-width:350px">
                        <a style='font-size:24pt' href="@prevPage"><span class="oi oi-arrow-left m-2 aria-hidden="true"></span></a>
                        @priority.number: @priority.title
                        <a style='font-size:24pt;float:right' href="@nextPage"><span class="oi oi-arrow-right m-2 aria-hidden="true"></span></a><br/>
                    </h2>

                    <h4>@((MarkupString)markupize(priority.priority))</h4>

                    <p><b>Summary:</b> @((MarkupString)markupize(priority.summary))</p>

                        @switch (priority.number) {
                            case 1:
                                <p><b>Worksheet:</b> </p>

                                <EditForm Model="taxFilings.Active" style=margin-left:25px>
                                    <DataAnnotationsValidator />
                                    <ValidationSummary />
                                    
                                    <label>Monthly Expenses:</label> <span>$</span><input class=dollar type=text @bind-Value="taxFilings.Active.EmergencyFund.MonthlyExpenses" @bind-Value:event="oninput" /><br/><br/>
                                    <label>Planned size of emergency fund:</label><br/>
                                    <InputRadioGroup @bind-Value=taxFilings.Active.EmergencyFund.TargetMonths>
                                        <InputRadio Value='0'/> None<br/>
                                        <InputRadio Value='1'/> 1 month: $@taxFilings.Active.EmergencyFund.MonthlyExpenses<br/>
                                        <InputRadio Value='3'/> 3 months: $@taxFilings.Active.EmergencyFund.ThreeMonths<br/>
                                        <InputRadio Value='4'/> Other: <br/>
                                    </InputRadioGroup>
                                    <div style="margin-left:20px">$<input type=text class=dollar @bind-Value="taxFilings.Active.EmergencyFund.EFOther" @bind-Value:event="oninput"/></div>
                                    <br/>
                                    <label>Current Size:</label> <span>$</span><input class=dollar type=text @bind-Value="taxFilings.Active.EmergencyFund.CurrentBalance" @bind-Value:event="oninput"/><br/><br/>
                                    <label>Amount to Save:</label> <span>$</span>@taxFilings.Active.EmergencyFund.AmountToSave<br/>
                                </EditForm><br/>
                                break;
                            case 2:
                                <p><b>Prerequisities:</b> </p>
                                <EditForm Model="taxFilings.Active" style=margin-left:25px>
                                    <label>Tax Filing Status:</label> <select @bind=taxFilings.Active.TaxFilingStatus>
                                                <option value=None>choose...</option>
                                                <option>Single</option>
                                                <option value=MarriedFilingJointly>Married filing jointly</option>
                                                <option value=MarriedFilingSeperately>Married filing seperately</option>
                                                <option value=MarriedFilingSeperatelyAndLivingApart>Married filing seperately (and living apart)</option>
                                                </select><br/>
                                </EditForm><br/>
                                @for (int i = 0; i < taxFilings.Active.PersonCount; i++) {
                                    var person = taxFilings.Active.People[i];
                                    var eligibleId = "eligible-" + i;
                                    <p><b>Person @(i+1):</b> </p>

                                    <EditForm Model="person" style=margin-left:25px>
                                        <InputCheckbox @bind-Value=person.EmployerPlan.Eligible id=@eligibleId /> <label style="display:inline" for=@eligibleId>Eligible for workplace retirement savings?</label><br/><br/>
                                        <fieldset disabled=@person.EmployerPlan.NotEligible style='margin-left:20px'>
                                            <label>Annual Salary:</label> $<input type=text class=percent @bind-Value=person.EmployerPlan.AnnualSalary @bind-Value:event=oninput /><br/>
                                            <label>Match:</label> <input type=text class=percent @bind-Value=person.EmployerPlan.MatchA @bind-Value:event=oninput />%
                                            <label margin-left:30px>Match Limit:</label> <input type=text class=percent @bind-Value=person.EmployerPlan.MatchALimit @bind-Value:event=oninput/>%<br/>
                                            <label>Match B:</label> <input type=text class=percent @bind-Value=person.EmployerPlan.MatchB @bind-Value:event=oninput />%
                                            <label margin-left:30px>Match B Limit:</label> <input type=text class=percent @bind-Value=person.EmployerPlan.MatchBLimit @bind-Value:event=oninput/>%<br/>
                                            <label>Max Match:</label> $<input type=text class=percent @bind-Value=person.EmployerPlan.MaxMatch @bind-Value:event=oninput/><br/>
                                            <label>Contribution required to get maximum match:</label> $<span>@person.EmployerPlan.AmountToSaveForMatch</span><br/>
                                            <label>Matched Amount:</label> $<span>@person.EmployerPlan.MatchAmount</span><br/>
                                        </fieldset>
                                    </EditForm><br/>
                                }

                                break;
                            case 4:
                                <p><b>Prerequisities:</b> </p>
                                <EditForm Model="taxFilings.Active" style=margin-left:25px>
                                    <label>Tax Filing Status:</label> <select @bind=taxFilings.Active.TaxFilingStatus>
                                                <option value=None>choose...</option>
                                                <option>Single</option>
                                                <option value=MarriedFilingJointly>Married filing jointly</option>
                                                <option value=MarriedFilingSeperately>Married filing seperately</option>
                                                <option value=MarriedFilingSeperatelyAndLivingApart>Married filing seperately (and living apart)</option>
                                                </select><br/>
                                </EditForm><br/>
                                @for (int i = 0; i < taxFilings.Active.PersonCount; i++) {
                                    var person = taxFilings.Active.People[i];
                                    var haveHDHPid = "eligible-" + i;
                                    <p><b>Person @(i+1):</b> </p>

                                    <EditForm Model="person" style=margin-left:25px>
                                        <InputCheckbox @bind-Value=person.HealthSavingsAccount.Eligible id='@haveHDHPid'/> <label for='@haveHDHPid' style="display:inline">Have high deductible health plan?</label><br/><br/>
                                        <fieldset disabled=@person.HealthSavingsAccount.NotEligible style='margin-left:20px'>
                                            <label>Individual/Family:</label>   <select @bind=person.HealthSavingsAccount.Family><option value=None>choose...</option><option value=EmployeeOnly>Employee only</option><option>Family</option></select><br/>
                                            <label>Contribution Limit:</label> $@person.HealthSavingsAccount.Limit<br/><br/>

                                            <label>2022 Employer Contribution:</label> $<input type=text class=dollar @bind-Value=person.HealthSavingsAccount.EmployerContribution @bind-Value:event=oninput><br/>
                                        </fieldset>
                                        <br/>
                                        <label>Amount to Save:</label> <span>$</span>@person.HealthSavingsAccount.AmountToSave<br/>
                                    </EditForm><br/>
                                }

                                break;
                            case 5:
                                <p><b>Prerequisities:</b> </p>
                                <EditForm Model="taxFilings.Active" style=margin-left:25px>
                                    <label>Tax Filing Status:</label> <select @bind=taxFilings.Active.TaxFilingStatus>
                                        <option value=None>choose...</option>
                                        <option>Single</option>
                                        <option value=MarriedFilingJointly>Married filing jointly</option>
                                        <option value=MarriedFilingSeperately>Married filing seperately</option>
                                        <option value=MarriedFilingSeperatelyAndLivingApart>Married filing seperately (and living apart)</option>
                                        </select><br/>
                                    <label>2022 Adjusted Gross Income:</label> $<input type=text class=dollar @bind-Value=taxFilings.Active.AdjustedGrossIncome @bind-Value:event=oninput /><br/>
                                </EditForm><br/>

                                if (taxFilings.Active.AdjustedGrossIncome != null) {
                                    @for (int i = 0; i < taxFilings.Active.PersonCount; i++) {
                                        var person = taxFilings.Active.People[i];
                                        var eligibleId = "eligible-" + i;
                                        var over50id = "over50-" + i;
                                        var tId = "traditional-" + i;
                                        var rId = "roth-" + i;
                                        var traditional = "traditional";
                                        var roth = "roth";
                                        <p><b>Person @(i+1):</b> </p>

                                        <EditForm Model="person" style=margin-left:25px>
                                            <InputCheckbox @bind-Value=person.EmployerPlan.Eligible id='@eligibleId'/> <label for='@eligibleId'>Eligible for workplace retirement savings?</label><br/><br/>
                                            <InputCheckbox id=@over50id @bind-Value=person.FiftyOrOver /> <label for=@over50id>50 or older?</label><br/><br/>

                                            <label><i>Choice of Contributions:</i></label><br/>
                                            <InputRadioGroup @bind-Value="person.IRAChoice">
                                                <InputRadio Value="traditional" id=@tId /> <label for=@tId>IRA: $<span>@person.IRA.AmountToSave</span> <span>($@person.IRA.DeductionAllowed Tax Deductible)</span><br/></label><br/>
                                                <InputRadio Value="roth" id=@rId/> <label for=@rId>Roth IRA: $<span>@person.RothIRA.AmountToSave</span><br/></label>
                                            </InputRadioGroup><br/>
                                        </EditForm><br/>
                                    }
                                }

                                break;
                            case 6:
                                <p><b>Prerequisities:</b> </p>

                                <EditForm Model="taxFilings.Active" style=margin-left:25px>
                                    <label>Tax Filing Status:</label> <select @bind=taxFilings.Active.TaxFilingStatus>
                                                <option value=None>choose...</option>
                                                <option>Single</option>
                                                <option value=MarriedFilingJointly>Married filing jointly</option>
                                                <option value=MarriedFilingSeperately>Married filing seperately</option>
                                                <option value=MarriedFilingSeperatelyAndLivingApart>Married filing seperately (and living apart)</option>
                                                </select><br/>
                                </EditForm><br/>
                                @for (int i = 0; i < taxFilings.Active.PersonCount; i++) {
                                    var person = taxFilings.Active.People[i];
                                    var eligibleId = "eligible-" + i;
                                    var fiftyLabel = "over50-" + i;
                                    <p><b>Person @(i+1):</b> </p>

                                    <EditForm Model="person" style=margin-left:25px>
                                        <InputCheckbox @bind-Value=person.EmployerPlan.Eligible id=@eligibleId /> <label for=@eligibleId>Eligible for workplace retirement savings?</label><br/><br/>

                                        <InputCheckbox id=@fiftyLabel @bind-Value=person.FiftyOrOver /> <label for=@fiftyLabel>50 or older?</label><br/><br/>

                                        <label>2022 401k Total Contribution Allowed:</label> $<span>@person.EmployerPlan.ContributionAllowed</span><br/>
                                        <label>minus Matched Contribution Allowed (step 2):</label> $<span>@person.EmployerPlan.AmountToSaveForMatch</span><br/>
                                        <label>Amount to Save (unmatched):</label> $<span>@person.EmployerPlan.AmountToSaveForNonMatched</span><br/>
                                    </EditForm><br/>
                                }

                                break;
                            case 7:
                                <p><b>Prerequisities:</b> </p>
                                <EditForm Model="taxFilings.Active" style=margin-left:25px>
                                    <label>Tax Filing Status:</label> <select @bind=taxFilings.Active.TaxFilingStatus>
                                        <option value=None>choose...</option>
                                        <option>Single</option>
                                        <option value=MarriedFilingJointly>Married filing jointly</option>
                                        <option value=MarriedFilingSeperately>Married filing seperately</option>
                                        <option value=MarriedFilingSeperatelyAndLivingApart>Married filing seperately (and living apart)</option>
                                        </select><br/>
                                </EditForm><br/>

                                @for (int i = 0; i < taxFilings.Active.PersonCount; i++) {
                                    var person = taxFilings.Active.People[i];
                                    <p><b>Person @(i+1):</b> </p>

                                    <EditForm Model="person" style=margin-left:25px>
                                        <InputCheckbox @bind-Value=person.EmployerPlan.Eligible id='eligible'/> <label for='eligible'>Eligible for workplace retirement savings?</label><br/><br/>

                                        <fieldset disabled=@person.EmployerPlan.NotEligible style='margin-left:20px'>
                                            <label>2022 Employer Post Tax "Mega Backdoor Roth" Contribution Allowed:</label> <span>$</span><input type=text class=dollar @bind-Value=person.EmployerPlan.AmountToSaveForBackdoorRoth @bind-Value:event=oninput/><br/><br/>
                                        </fieldset>
                                        <label>Amount to Save:</label> <span>$</span><span>@person.EmployerPlan.AmountToSaveForBackdoorRoth</span><br/>
                                    </EditForm><br/>
                                }

                                break;
                            case 9:
                                <label style=margin-left:25px>Amount to Save:</label> <span>no limits</span><br/><br/>
                                break;
                            case 3:
                            case 8:
                            case 10:
                                <p><b>Worksheet:</b> </p>
                                <div>
                                    <i>list of debts (all interest rates):</i><br>
                                    <EditForm Model="taxFilings.Active">
                                        <table>
                                            <thead>
                                            <th><label>name</label></th>
                                            <th><label>interest %</label></th>
                                            <th><label>category</label></th>
                                            <th><label>total $</label></th>
                                            <th><label>payoff date</label></th>
                                            <th><label></label></th>
                                            </thead>
                                            @foreach (var debt in taxFilings.Active.Debts) {
                                                var myDebt = debt;
                                                <tr>
                                                <td><input type=text class=dollar @bind-Value=debt.Name @bind-Value:event=oninput /></td>
                                                <td><input type=text class=dollar @bind-Value=debt.Rate @bind-Value:event=oninput /></td>
                                                <td><span>@debt.Category</span></td>
                                                <td><input type=text class=dollar @bind-Value=debt.Total @bind-Value:event=oninput /></td>
                                                <td><input type=text class=dollar @bind-Value=debt.PayoffDate @bind-Value:event=oninput /></td>
                                                <td><button @onclick=@(() => taxFilings.Active.Debts.Remove(myDebt))>@myDebt.Name<span class="oi oi-delete" aria-hidden="true"></span></button></td>
                                                </tr>
                                            }
                                        </table>
                                        <button @onclick=addDebt>Add</button>

                                        <br/><br/>
                                        <label>Amount to Pay-Off (@priority.title):</label> <span>$</span>
                                        @switch (priority.number) {
                                            case 3:
                                                @taxFilings.Active.HighDebts;
                                                break;
                                            case 8:
                                                @taxFilings.Active.MediumDebts;
                                                break;
                                            case 10:
                                                @taxFilings.Active.LowDebts;
                                                break;
                                            default:
                                                break;
                                        }
                                        <br/><br/>
                                    </EditForm>
                                </div>

                                @code{
                                    void addDebt()
                                    {
                                        taxFilings.Active?.Debts.Add(new Debt() { Name = "new", Rate = 3.0, Total = 5000 });
                                    }
                                }
                            
                                break;
                        }
                    <p><b>Approximate Return:</b> @priority.returns</p>
                    <p><b>Details:</b> @((MarkupString)markupize(priority.description))</p>

                    <a style='font-size:24pt' href="@prevPage"><span class="oi oi-arrow-left m-2 aria-hidden="true"></span></a>
                    <a style='font-size:24pt;float:right' href="@nextPage"><span class="oi oi-arrow-right m-2 aria-hidden="true"></span></a><br/>
                }
            }
        }
    }

@code {
    public enum Mode {
        normal = 0,
        href,
        text,
    }
    public string markupize(string? wikiText) {
        if (wikiText == null) return "";
        string returnVal = "<span>";
        char lastChar = 'x';
        var mode = Mode.normal;
        string href = "";
        string text = "";
        foreach (var c in wikiText) {
            switch (c) {
                case '[':
                    if (lastChar == '[') {
                        mode = Mode.href;
                    }
                    break;
                case ']':
                    if (lastChar == ']') {
                        if (text == "") { text = href; }
                        returnVal += "<a href='https://www.bogleheads.org/wiki/" + href + "'>" + text + "</a>";
                        href = "";
                        text = "";
                        mode = Mode.normal;
                    }
                    break;
                case '|':
                    if (mode == Mode.href) {
                        mode = Mode.text;
                    }
                    break;
            }

            switch (mode) {
                case Mode.href:
                    switch (c) {
                        case '[':
                        case ']':
                            break;
                        default:
                            href += c;
                            break;
                    }
                    break;
                case Mode.text:
                    switch (c) {
                        case '[':
                        case ']':
                        case '|':
                            break;
                        default:
                            text += c;
                            break;
                    }
                    break;
                default:
                    switch (c) {
                        case '[':
                        case ']':
                            break;
                        case '\n':
                            returnVal += "<br/>";
                            break;
                        default:
                            returnVal += c;
                            break;
                    }
                    break;
            }

            lastChar = c;
        }
        returnVal += "</span>";

        return returnVal;
    }

    [Parameter]
    public string? stepPath { get; set; }

    private InvestmentPriority[]? priorities;
    private static Retirement? irs_retirement_year1;
    private static Retirement? irs_retirement_year2;
    private TaxFilings? taxFilings;

    protected override async Task OnInitializedAsync()
    {
        priorities = await Http.GetFromJsonAsync<InvestmentPriority[]>("data/investment-priorities.json");
        var retirementYear1 = await Http.GetStreamAsync("https://raw.githubusercontent.com/bogle-tools/financial-variables/main/data/usa/irs/irs.retirement.2022.json");
        var retirementYear2 = await Http.GetStreamAsync("https://raw.githubusercontent.com/bogle-tools/financial-variables/main/data/usa/irs/irs.retirement.2023.json");
        irs_retirement_year1 = JsonSerializer.Deserialize<IRS.Retirement>(retirementYear1);
        irs_retirement_year2 = JsonSerializer.Deserialize<IRS.Retirement>(retirementYear2);

        if (irs_retirement_year1 != null && irs_retirement_year2 != null) {
            taxFilings = new(irs_retirement_year1, irs_retirement_year2);
            taxFilings.CurrentYear = 1;
        }
    }
}
